# 運用マニュアル

## 目次
1. [日常運用](#日常運用)
2. [監視とログ](#監視とログ)
3. [バックアップとリストア](#バックアップとリストア)
4. [トラブルシューティング](#トラブルシューティング)
5. [メンテナンス](#メンテナンス)

## 日常運用

### 定期実行の設定

1. cronジョブの設定（Linuxの場合）
```bash
# 毎日午前0時に実行
0 0 * * * cd /path/to/fanza-wordpress-autopost && ./venv/bin/python -m src.main
```

2. タスクスケジューラの設定（Windowsの場合）
- タスクスケジューラを開く
- 「基本タスクの作成」を選択
- トリガーを「毎日」に設定
- 操作を「プログラムの開始」に設定
- プログラムに`python`を指定
- 引数に`-m src.main`を指定

### 実行状態の確認

1. ログファイルの確認
```bash
# 最新のエラーログを確認
tail -f logs/error.log

# 最新の警告ログを確認
tail -f logs/warning.log
```

2. キャッシュの状態確認
```bash
# キャッシュディレクトリのサイズ確認
du -sh cache/

# キャッシュファイルの一覧
ls -l cache/
```

## 監視とログ

### ログ管理

1. ログローテーション
- ログファイルは自動的にローテーションされます
- 設定可能なパラメータ：
  - ログファイルの最大サイズ
  - 保持するログファイルの数
  - ローテーションのタイミング

2. ログレベル
- ERROR: エラー情報
- WARNING: 警告情報
- INFO: 通常の動作情報
- DEBUG: デバッグ情報

### パフォーマンス監視

1. リソース使用量の監視
- CPU使用率
- メモリ使用量
- ディスク使用量
- ネットワーク使用量

2. API制限の監視
- FANZA APIのレート制限
- WordPress APIの制限
- Grok APIの制限（使用時）

## バックアップとリストア

### バックアップ

1. 設定ファイルのバックアップ
```bash
# .envファイルのバックアップ
cp .env .env.backup

# 設定ファイルのバックアップ
cp config.json config.json.backup
```

2. キャッシュのバックアップ
```bash
# キャッシュディレクトリのバックアップ
tar -czf cache_backup.tar.gz cache/
```

3. ログのバックアップ
```bash
# ログディレクトリのバックアップ
tar -czf logs_backup.tar.gz logs/
```

### リストア

1. 設定ファイルのリストア
```bash
# .envファイルのリストア
cp .env.backup .env

# 設定ファイルのリストア
cp config.json.backup config.json
```

2. キャッシュのリストア
```bash
# キャッシュディレクトリのリストア
tar -xzf cache_backup.tar.gz
```

3. ログのリストア
```bash
# ログディレクトリのリストア
tar -xzf logs_backup.tar.gz
```

## トラブルシューティング

### エラー対応

1. APIエラー
- エラーログを確認
- APIキーの有効性を確認
- レート制限に達していないか確認

2. WordPress接続エラー
- 接続設定を確認
- WordPressの状態を確認
- ネットワーク接続を確認

3. キャッシュエラー
- キャッシュディレクトリのパーミッションを確認
- ディスク容量を確認
- キャッシュをクリア

### パフォーマンス問題

1. 処理が遅い場合
- ログを確認してボトルネックを特定
- 並列処理の設定を調整
- キャッシュの設定を最適化

2. メモリ使用量が多い場合
- キャッシュサイズを調整
- 並列処理数を制限
- 不要なデータをクリア

## メンテナンス

### 定期メンテナンス

1. キャッシュのクリーンアップ
```bash
# 古いキャッシュを削除
python -m src.utils.cache_cleaner --days 7
```

2. ログのクリーンアップ
```bash
# 古いログを削除
python -m src.utils.log_cleaner --days 30
```

3. 設定の更新
- 新しい機能の追加時
- セキュリティアップデート時
- パフォーマンス改善時

### アップデート

1. コードの更新
```bash
# 最新のコードを取得
git pull origin main

# 依存パッケージの更新
pip install -r requirements.txt --upgrade
```

2. 設定の更新
- 新しい設定項目の追加
- 既存の設定値の更新
- 不要な設定の削除

3. データベースの更新
- スキーマの更新
- インデックスの最適化
- 不要なデータの削除 